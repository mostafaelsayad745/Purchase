<div class="container">
  <div class="page-header" style="display: flex; justify-content: space-between; align-items: center;">
    <div>
      <h2>๐ฐ ุนุฑูุถ ุงูุฃุณุนุงุฑ</h2>
      <p class="subtitle">Quotations - Steps 4-5: Supplier Selection & Best Offer Approval</p>
    </div>
    <button class="btn btn-primary" (click)="showCreateForm = !showCreateForm">
      {{ showCreateForm ? 'ุฅุฎูุงุก ุงููููุฐุฌ' : '+ ุฅุถุงูุฉ ุนุฑุถ ุณุนุฑ ูุฏููุงู' }}
    </button>
  </div>

  <!-- Manual Create Form -->
  <div *ngIf="showCreateForm" class="card" style="background: #f8f9fa; margin-bottom: 20px;">
    <h3>ุฅุถุงูุฉ ุนุฑุถ ุณุนุฑ ุฌุฏูุฏ</h3>
    <form (ngSubmit)="createQuotation()">
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
        <div class="form-group">
          <label class="form-label">ุทูุจ ุงูุดุฑุงุก *</label>
          <select class="form-control" [(ngModel)]="newQuotation.purchaseRequestId" name="purchaseRequestId" required>
            <option [value]="0">-- ุงุฎุชุฑ ุทูุจ ุงูุดุฑุงุก --</option>
            <option *ngFor="let pr of purchaseRequests" [value]="pr.id">
              {{ pr.toolNameAr }} (ุทูุจ #{{ pr.id }})
            </option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">ุงูููุฑุฏ *</label>
          <select class="form-control" [(ngModel)]="newQuotation.supplierId" name="supplierId" required>
            <option [value]="0">-- ุงุฎุชุฑ ุงูููุฑุฏ --</option>
            <option *ngFor="let supplier of suppliers" [value]="supplier.id">
              {{ supplier.nameAr }}
            </option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">ุงููููุฉ ุงููุนุฑูุถุฉ *</label>
          <input type="number" class="form-control" [(ngModel)]="newQuotation.quantityOffered" name="quantityOffered" min="1" required />
        </div>
        <div class="form-group">
          <label class="form-label">ุณุนุฑ ุงููุญุฏุฉ (ุฑูุงู) *</label>
          <input type="number" class="form-control" [(ngModel)]="newQuotation.unitPrice" name="unitPrice" min="0.01" step="0.01" required />
        </div>
        <div class="form-group">
          <label class="form-label">ูุฏุฉ ุงูุชุณููู (ุฃูุงู) *</label>
          <input type="number" class="form-control" [(ngModel)]="newQuotation.deliveryTimeDays" name="deliveryTimeDays" min="1" required />
        </div>
        <div class="form-group">
          <label class="form-label">ููุงุญุธุงุช</label>
          <textarea class="form-control" [(ngModel)]="newQuotation.notes" name="notes" rows="2"></textarea>
        </div>
      </div>
      <div style="display: flex; gap: 12px; margin-top: 16px;">
        <button type="submit" class="btn btn-success" [disabled]="creating">
          {{ creating ? 'ุฌุงุฑู ุงูุญูุธ...' : 'ุญูุธ ุงูุนุฑุถ' }}
        </button>
        <button type="button" class="btn" (click)="showCreateForm = false; resetForm()" style="background: #6c757d; color: white;">
          ุฅูุบุงุก
        </button>
      </div>
    </form>
  </div>

  <div class="filter-section">
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
      <div>
        <label for="prFilter">ุชุตููุฉ ุญุณุจ ุทูุจ ุงูุดุฑุงุก:</label>
        <select id="prFilter" class="form-control" [(ngModel)]="selectedPurchaseRequestId" (change)="filterByPurchaseRequest()">
          <option [ngValue]="null">ุงููู</option>
          <option *ngFor="let pr of purchaseRequests" [ngValue]="pr.id">
            {{ pr.toolNameAr }} (ุทูุจ #{{ pr.id }})
          </option>
        </select>
      </div>
      <div>
        <label for="supplierFilter">ุชุตููุฉ ุญุณุจ ุงูููุฑุฏ:</label>
        <input type="text" id="supplierFilter" class="form-control" [(ngModel)]="filterSupplierName" (input)="applyFilters()" placeholder="ุงุจุญุซ ุนู ุงูููุฑุฏ..." />
      </div>
      <div>
        <label for="dateFilter">ุชุตููุฉ ุญุณุจ ุงูุชุงุฑูุฎ:</label>
        <input type="date" id="dateFilter" class="form-control" [(ngModel)]="filterDate" (change)="applyFilters()" />
      </div>
    </div>
  </div>

  <div *ngIf="loading" class="loading">
    <div class="spinner"></div>
    <p>ุฌุงุฑู ุงูุชุญููู...</p>
  </div>

  <div *ngIf="error" class="error-message">
    {{ error }}
  </div>

  <div *ngIf="!loading && !error">
    <!-- Grouped by Purchase Request -->
    <div *ngFor="let prId of getGroupKeys()" class="pr-group">
      <h3 class="pr-header">
        ๐๏ธ {{ getPurchaseRequestName(prId) }}
        <span class="quote-count">{{ groupedQuotations.get(prId)?.length }} ุนุฑุถ</span>
      </h3>
      
      <div class="quotations-grid">
        <div *ngFor="let quotation of groupedQuotations.get(prId)" 
             class="quotation-card"
             [class.selected]="quotation.isSelected"
             [class]="getRankingClass(quotation.ranking)">
          
          <!-- Ranking Badge -->
          <div *ngIf="quotation.ranking && quotation.ranking <= 3" class="ranking-badge">
            {{ getRankingBadge(quotation.ranking) }}
          </div>

          <!-- Supplier Info -->
          <div class="supplier-section">
            <h4>{{ quotation.supplierNameAr }}</h4>
            <p class="supplier-name-en">{{ quotation.supplierNameEn }}</p>
          </div>

          <!-- Quotation Details -->
          <div class="details-section">
            <div class="detail-row">
              <span class="label">ุงููููุฉ ุงููุนุฑูุถุฉ:</span>
              <span class="value">{{ quotation.quantityOffered }} ูุทุนุฉ</span>
            </div>
            <div class="detail-row">
              <span class="label">ุณุนุฑ ุงููุญุฏุฉ:</span>
              <span class="value price">{{ quotation.unitPrice | number:'1.2-2' }} ุฑูุงู</span>
            </div>
            <div class="detail-row">
              <span class="label">ุงูุณุนุฑ ุงูุฅุฌูุงูู:</span>
              <span class="value total-price">{{ quotation.totalPrice | number:'1.2-2' }} ุฑูุงู</span>
            </div>
            <div class="detail-row">
              <span class="label">ูุฏุฉ ุงูุชุณููู:</span>
              <span class="value">{{ quotation.deliveryTimeDays }} ููู</span>
            </div>
            <div class="detail-row">
              <span class="label">ุชุงุฑูุฎ ุงูุนุฑุถ:</span>
              <span class="value">{{ quotation.quotationDate | date:'yyyy-MM-dd' }}</span>
            </div>
            <div *ngIf="quotation.notes" class="detail-row notes">
              <span class="label">ููุงุญุธุงุช:</span>
              <span class="value">{{ quotation.notes }}</span>
            </div>
          </div>

          <!-- Selection/Rejection Info -->
          <div *ngIf="quotation.isSelected" class="status-section selected-status">
            <strong>โ ุชู ุงุฎุชูุงุฑ ูุฐุง ุงูุนุฑุถ</strong>
            <p *ngIf="quotation.selectionReason">{{ quotation.selectionReason }}</p>
          </div>
          <div *ngIf="quotation.rejectionReason" class="status-section rejected-status">
            <strong>โ ุชู ุฑูุถ ูุฐุง ุงูุนุฑุถ</strong>
            <p>{{ quotation.rejectionReason }}</p>
          </div>

          <!-- Action Buttons -->
          <div class="action-buttons" *ngIf="!quotation.isSelected && !quotation.rejectionReason">
            <button 
              *ngIf="quotation.ranking && quotation.ranking <= 3"
              class="btn btn-success"
              (click)="selectQuotation(quotation)"
              title="ุงุฎุชูุงุฑ ุงูุนุฑุถ">
              โ ุงุฎุชูุงุฑ
            </button>
            <button 
              class="btn btn-danger"
              (click)="rejectQuotation(quotation)"
              title="ุฑูุถ ุงูุนุฑุถ">
              โ ุฑูุถ
            </button>
          </div>
        </div>
      </div>
    </div>

    <div *ngIf="quotations.length === 0" class="no-data">
      ูุง ุชูุฌุฏ ุนุฑูุถ ุฃุณุนุงุฑ
    </div>
  </div>

  <div class="info-section">
    <h3>๐ ูุนูููุงุช ุนู ุนุฑูุถ ุงูุฃุณุนุงุฑ</h3>
    <ul>
      <li><strong>ุงูุฎุทูุฉ 4:</strong> ุฌูุน ุนุฑูุถ ุงูุฃุณุนุงุฑ ูู 3 ููุฑุฏูู ูุญุฏ ุฃุฏูู</li>
      <li><strong>ุงูุชุฑุชูุจ ุงูุชููุงุฆู:</strong> ูุชู ุชุฑุชูุจ ุฃูุถู 3 ุนุฑูุถ ุนูู ุฃุณุงุณ ุงูุณุนุฑ</li>
      <li><strong>ุงูุฎุทูุฉ 5:</strong> ุงูููุงููุฉ ุงูุซุงููุฉ - ุงุฎุชูุงุฑ ุฃูุถู ุนุฑุถ</li>
      <li><strong>ุงููุณุคูู:</strong> SecondApprover (ุงูููุงูู ุงูุซุงูู)</li>
      <li><strong>ูุนุงููุฑ ุงูุงุฎุชูุงุฑ:</strong> ุงูุณุนุฑุ ููุช ุงูุชุณูููุ ุชูููู ุงูููุฑุฏุ ุฌูุฏุฉ ุงูููุชุฌ</li>
      <li><strong>ุจุนุฏ ุงูุงุฎุชูุงุฑ:</strong> ุงูุงูุชูุงู ุฅูู ุงูุฎุทูุฉ 6 (ุฅูุดุงุก ุฃูุฑ ุงูุดุฑุงุก)</li>
    </ul>
  </div>
</div>
